<!DOCTYPE html><html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nosson Stock HQ — Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.7)}
    .dark .glass{background:rgba(15,23,42,.6)}
    .shine{background:linear-gradient(110deg,rgba(255,255,255,.06),rgba(255,255,255,0) 42%,rgba(255,255,255,.1) 58%,rgba(255,255,255,0));background-size:200% 100%;animation:shine 7s linear infinite}
    @keyframes shine{0%{background-position:120% 0}100%{background-position:-20% 0}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
    <header class="flex flex-col md:flex-row md:items-end gap-6 justify-between">
      <div>
        <h1 class="text-4xl font-extrabold">Nosson’s Stock HQ</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">Live updates for VTAK • APVO • HYFT — uses Yahoo Finance public quote API (prefers AH/PM prices when present)</p>
      </div>
      <div class="flex gap-2">
        <button id="darkBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900">Toggle Dark</button>
        <button id="resetBtn" class="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700">Reset</button>
      </div>
    </header><section class="glass shine rounded-2xl p-4 md:p-6 space-y-4">
  <div class="flex flex-wrap items-center gap-4 justify-between">
    <div class="flex items-baseline gap-3">
      <div class="text-sm text-slate-500">Portfolio Total</div>
      <div id="total" class="text-3xl font-bold tabular-nums">$—</div>
      <div id="delta" class="text-sm"></div>
    </div>
    <div class="flex items-center gap-3">
      <label class="text-sm">Auto-refresh</label>
      <select id="freq" class="px-3 py-2 rounded-xl bg-white dark:bg-slate-800">
        <option value="60000">1 min</option>
        <option value="300000" selected>5 min</option>
        <option value="900000">15 min</option>
      </select>
      <button id="liveBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Start</button>
      <div id="liveStatus" class="text-sm text-slate-500">Idle</div>
    </div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 space-y-2">
      <div class="flex items-center justify-between"><h3 class="font-semibold">VTAK</h3><span id="ms-VTAK" class="text-xs text-slate-500"></span></div>
      <div class="text-2xl font-bold tabular-nums" id="px-VTAK">$—</div>
      <div class="text-xs text-slate-500">Shares: <input id="sh-VTAK" type="number" class="w-20 px-2 py-1 rounded bg-slate-100 dark:bg-slate-700" value="3"/></div>
      <div class="text-sm" id="val-VTAK">—</div>
    </div>
    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 space-y-2">
      <div class="flex items-center justify-between"><h3 class="font-semibold">APVO</h3><span id="ms-APVO" class="text-xs text-slate-500"></span></div>
      <div class="text-2xl font-bold tabular-nums" id="px-APVO">$—</div>
      <div class="text-xs text-slate-500">Shares: <input id="sh-APVO" type="number" class="w-20 px-2 py-1 rounded bg-slate-100 dark:bg-slate-700" value="6"/></div>
      <div class="text-sm" id="val-APVO">—</div>
    </div>
    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 space-y-2">
      <div class="flex items-center justify-between"><h3 class="font-semibold">HYFT</h3><span id="ms-HYFT" class="text-xs text-slate-500"></span></div>
      <div class="text-2xl font-bold tabular-nums" id="px-HYFT">$—</div>
      <div class="text-xs text-slate-500">Shares: <input id="sh-HYFT" type="number" class="w-20 px-2 py-1 rounded bg-slate-100 dark:bg-slate-700" value="173"/></div>
      <div class="text-sm" id="val-HYFT">—</div>
    </div>
  </div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 glass rounded-2xl p-4 md:p-6">
    <h3 class="text-lg font-semibold mb-3">Updates Feed</h3>
    <div id="feed" class="space-y-3"></div>
  </div>
  <div class="glass rounded-2xl p-4 md:p-6">
    <h3 class="text-lg font-semibold mb-3">Equity Curve</h3>
    <canvas id="eq" height="160"></canvas>
  </div>
</section>

<footer class="text-xs text-slate-500 text-center pb-8">Built for Nosson • Live quotes fetched from Yahoo Finance public endpoint. If blocked by CORS in your region, switch to Vercel function /api/quote (same JSON).</footer>

  </div>  <div id="ticker" class="fixed bottom-0 left-0 right-0 bg-slate-900 text-white text-sm py-2 px-4 flex gap-6 overflow-x-auto">Loading…</div><script>
const syms = ['VTAK','APVO','HYFT'];
const state = {
  shares: { VTAK: 3, APVO: 6, HYFT: 173 },
  prices: { VTAK: null, APVO: null, HYFT: null },
  lastTotal: null,
  history: [], // {t, total}
  timer: null,
  freq: 300000,
};

// Persist
function save(){ localStorage.setItem('nosson_live_v2', JSON.stringify({shares:state.shares, history:state.history})); }
function load(){
  const s = JSON.parse(localStorage.getItem('nosson_live_v2')||'null');
  if(s){ state.shares = Object.assign(state.shares, s.shares||{}); state.history = s.history||[]; }
  document.getElementById('sh-VTAK').value = state.shares.VTAK;
  document.getElementById('sh-APVO').value = state.shares.APVO;
  document.getElementById('sh-HYFT').value = state.shares.HYFT;
}

// UI helpers
function $(id){return document.getElementById(id)}
function fmt(n){return Number(n).toFixed(4)}
function money(n){return `$${Number(n).toFixed(2)}`}

// Fetch from Yahoo Finance public endpoint
async function fetchQuotes(){
  const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${syms.join(',')}`;
  const r = await fetch(url, {cache:'no-store'});
  const j = await r.json();
  const list = j.quoteResponse.result || [];
  const bySym = {};
  list.forEach(q=>{ bySym[q.symbol.toUpperCase()] = q; });
  return syms.map(s=> bySym[s]||{symbol:s});
}

function choosePrice(q){
  if(!q) return null;
  if((q.marketState==='POST' || q.marketState==='POSTPOST') && q.postMarketPrice) return q.postMarketPrice;
  if((q.marketState==='PRE' || q.marketState==='PREPRE') && q.preMarketPrice) return q.preMarketPrice;
  return q.regularMarketPrice ?? q.ask ?? q.bid ?? q.previousClose ?? null;
}

async function refresh(){
  try{
    const quotes = await fetchQuotes();
    let total = 0; const parts = [];
    for(const q of quotes){
      const s = (q.symbol||'').toUpperCase();
      const px = choosePrice(q);
      if(px!=null) state.prices[s]=px;
      const shares = state.shares[s];
      const val = (px||0) * (shares||0);
      total += val;
      $(`px-${s}`).textContent = px? money(px) : '$—';
      $(`ms-${s}`).textContent = q.marketState || '';
      $(`val-${s}`).textContent = `${shares} × ${px? money(px):'$—'} = ${money(val)}`;
      parts.push(`${s} ${px? px.toFixed(2):'—'}`);
    }
    $('#total').textContent = money(total);
    if(state.lastTotal!=null){
      const d = total - state.lastTotal;
      const pct = state.lastTotal? (d/state.lastTotal*100):0;
      $('#delta').textContent = `${d>=0?'+':''}${d.toFixed(2)} (${pct>=0?'+':''}${pct.toFixed(2)}%) since last`;
      $('#delta').className = d>=0? 'text-green-600' : 'text-red-600';
    }
    state.lastTotal = total;
    state.history.push({t:Date.now(), total:Number(total.toFixed(2))});
    if(state.history.length>400) state.history.shift();
    save();
    appendFeed(`Auto • ${new Date().toLocaleTimeString()} → ${parts.join(' · ')} | Total ${money(total)}`);
    drawChart();
    drawTicker();
  }catch(e){ appendFeed('Fetch error — falling back'); console.warn(e); }
}

function appendFeed(text){
  const wrap = document.createElement('div');
  wrap.className = 'bg-white dark:bg-slate-800 rounded-xl p-3 shadow';
  wrap.textContent = text;
  $('#feed').prepend(wrap);
  const max = 150; const feed = $('#feed');
  while(feed.children.length>max){ feed.lastChild.remove(); }
}

let eqChart;
function drawChart(){
  const labels = state.history.map(p=> new Date(p.t).toLocaleTimeString());
  const data = state.history.map(p=> p.total);
  if(eqChart) eqChart.destroy();
  eqChart = new Chart($('#eq'), {type:'line', data:{labels, datasets:[{label:'Total ($)', data, tension:.25}]}, options:{responsive:true, maintainAspectRatio:false}});
}

function drawTicker(){
  const el = $('#ticker');
  el.innerHTML = syms.map(s=>{
    const px = state.prices[s];
    return `<span class='font-semibold'>${s}</span> ${px? px.toFixed(2):'—'}`;
  }).join('<span class="opacity-40"> | </span>');
}

// Controls
['VTAK','APVO','HYFT'].forEach(s=>{
  $(`sh-${s}`).addEventListener('input', (e)=>{ state.shares[s] = Number(e.target.value)||0; save(); refresh(); });
});

$('#darkBtn').addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));
$('#resetBtn').addEventListener('click', ()=>{ localStorage.removeItem('nosson_live_v2'); location.reload(); });

$('#liveBtn').addEventListener('click', ()=>{
  if(state.timer){ clearInterval(state.timer); state.timer=null; $('#liveBtn').textContent='Start'; $('#liveStatus').textContent='Idle'; return; }
  state.freq = Number($('#freq').value)||300000;
  state.timer = setInterval(refresh, state.freq);
  $('#liveBtn').textContent='Stop';
  $('#liveStatus').textContent=`Running every ${Math.round(state.freq/60000)} min`;
  refresh();
});

// Init
load();
refresh();
</script></body>
</html>
