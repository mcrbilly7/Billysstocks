<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nosson Stock HQ — Live v3 (Max)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.72)}
    .dark .glass{background:rgba(17,24,39,.55)}
    .shine{background:linear-gradient(110deg,rgba(255,255,255,.06),rgba(255,255,255,0) 42%,rgba(255,255,255,.1) 58%,rgba(255,255,255,0));background-size:200% 100%;animation:shine 7s linear infinite}
    .ticker{white-space:nowrap; animation:ticker 25s linear infinite}
    @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end gap-6 justify-between">
      <div>
        <h1 class="text-4xl font-extrabold">Nosson’s Stock HQ</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">
          Live AH/PM-aware dashboard for VTAK · APVO · HYFT — proxies Yahoo via /api/quote; configurable refresh; local history + exports.
        </p>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="darkBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900">Dark</button>
        <button id="notifyBtn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white">Enable Alerts</button>
        <button id="exportBtn" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Export JSON</button>
        <label class="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 cursor-pointer">
          Import JSON <input id="importFile" type="file" accept="application/json" class="hidden"/>
        </label>
        <button id="resetBtn" class="px-3 py-2 rounded-xl bg-rose-600 text-white">Reset</button>
      </div>
    </header>

    <!-- Live controls / totals -->
    <section class="glass shine rounded-2xl p-4 md:p-6 space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-baseline gap-3">
          <div class="text-sm text-slate-500">Portfolio Total</div>
          <div id="total" class="text-3xl font-bold tabular-nums">$—</div>
          <div id="delta" class="text-sm"></div>
        </div>
        <div class="flex items-center gap-3">
          <label class="text-sm">Auto-refresh</label>
          <select id="freq" class="px-3 py-2 rounded-xl bg-white dark:bg-slate-800">
            <option value="60000">1 min</option>
            <option value="300000" selected>5 min</option>
            <option value="900000">15 min</option>
          </select>
          <button id="liveBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Start</button>
          <div id="liveStatus" class="text-sm text-slate-500">Idle</div>
          <div id="countdown" class="text-xs text-slate-400"></div>
        </div>
      </div>

      <!-- Positions row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-xl bg-white dark:bg-slate-800 p-4 space-y-2">
          <div class="flex items-center justify-between"><h3 class="font-semibold">VTAK</h3><span id="ms-VTAK" class="text-xs text-slate-500"></span></div>
          <div class="text-2xl font-bold tabular-nums" id="px-VTAK">$—</div>
          <div class="text-xs text-slate-500">Shares: <input id="sh-VTAK" type="number" class="w-24 px-2 py-1 rounded bg-slate-100 dark:bg-slate-700" value="3"/></div>
          <div class="text-sm" id="val-VTAK">—</div>
        </div>
        <div class="rounded-xl bg-white dark:bg-slate-800 p-4 space-y-2">
          <div class="flex items-center justify-between"><h3 class="font-semibold">APVO</h3><span id="ms-APVO" class="text-xs text-slate-500"></span></div>
          <div class="text-2xl font-bold tabular-nums" id="px-APVO">$—</div>
          <div class="text-xs text-slate-500">Shares: <input id="sh-APVO" type="number" class="w-24 px-2 py-1 rounded bg-slate-100 dark:bg-slate-700" value="6"/></div>
          <div class="text-sm" id="val-APVO">—</div>
        </div>
        <div class="rounded-xl bg-white dark:bg-slate-800 p-4 space-y-2">
          <div class="flex items-center justify-between"><h3 class="font-semibold">HYFT</h3><span id="ms-HYFT" class="text-xs text-slate-500"></span></div>
          <div class="text-2xl font-bold tabular-nums" id="px-HYFT">$—</div>
          <div class="text-xs text-slate-500">Shares: <input id="sh-HYFT" type="number" class="w-24 px-2 py-1 rounded bg-slate-100 dark:bg-slate-700" value="173"/></div>
          <div class="text-sm" id="val-HYFT">—</div>
        </div>
      </div>
    </section>

    <!-- Main grid: feed + chart + insights -->
    <section class="grid grid-cols-1 2xl:grid-cols-3 gap-6">
      <div class="2xl:col-span-2 space-y-6">
        <div class="glass rounded-2xl p-4 md:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Updates Feed</h3>
            <div class="flex items-center gap-2">
              <input id="noteInput" placeholder="Add a note (e.g., HYFT watch 1.85; stop 1.66)" class="px-3 py-2 rounded-xl bg-white dark:bg-slate-800 w-64"/>
              <button id="addNote" class="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700">Post</button>
            </div>
          </div>
          <div id="feed" class="space-y-3 max-h-[46vh] overflow-auto"></div>
        </div>
        <div class="glass rounded-2xl p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-3">Equity Curve</h3>
          <canvas id="eq" height="200"></canvas>
        </div>
      </div>
      <div class="space-y-6">
        <div class="glass rounded-2xl p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-3">Insights</h3>
          <ul id="insights" class="text-sm space-y-1"></ul>
        </div>
        <div class="glass rounded-2xl p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-3">Key Levels</h3>
          <ul id="levels" class="text-sm space-y-2"></ul>
          <div class="mt-2 flex gap-2">
            <input id="levelInput" placeholder="e.g., HYFT R 1.85 / S 1.66" class="flex-1 px-3 py-2 rounded-xl bg-white dark:bg-slate-800"/>
            <button id="addLevel" class="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700">Save</button>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-3">Watchlist (under $10)</h3>
          <ul id="watch" class="text-sm space-y-2"></ul>
          <div class="mt-2 flex gap-2">
            <input id="watchInput" placeholder="Add ticker…" class="flex-1 px-3 py-2 rounded-xl bg-white dark:bg-slate-800"/>
            <button id="addWatch" class="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700">Add</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-xs text-slate-500 text-center pb-8">
      Built for Nosson • Frontend calls <code>/api/quote</code> first, falls back to Yahoo if needed.
    </footer>
  </div>

  <!-- Scrolling ticker bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-slate-900 text-white py-2 overflow-hidden">
    <div id="ticker" class="ticker flex gap-8 px-4"></div>
  </div>

<script>
const syms = ['VTAK','APVO','HYFT'];
const StoreKey = 'nosson_live_v3';
const state = {
  shares: { VTAK: 3, APVO: 6, HYFT: 173 },
  prices: { VTAK: null, APVO: null, HYFT: null },
  history: [], // {t,total}
  feed: [],   // {t,text}
  levels: [], // strings
  watch: [],  // tickers
  lastTotal: null,
  timer: null, nextAt: null, freq: 300000
};

// ==== Persistence
function save(){ localStorage.setItem(StoreKey, JSON.stringify({shares:state.shares, history:state.history, feed:state.feed, levels:state.levels, watch:state.watch})); }
function load(){
  try{ const s = JSON.parse(localStorage.getItem(StoreKey)||'null'); if(s){ Object.assign(state.shares, s.shares||{}); state.history=s.history||[]; state.feed=s.feed||[]; state.levels=s.levels||[]; state.watch=s.watch||[]; } }catch{}
  ['VTAK','APVO','HYFT'].forEach(s=>{ document.getElementById('sh-'+s).value = state.shares[s]; });
  renderFeed(); renderLevels(); renderWatch(); drawChart();
}

// ==== Utilities
const $ = (id)=> document.getElementById(id);
const money = (n)=> '$'+Number(n).toFixed(2);

// ==== Quotes (tries /api/quote first, then Yahoo)
async function fetchQuotes(){
  const symbols = syms.join(',');
  try{
    const r = await fetch(`/api/quote?symbols=${symbols}`, {cache:'no-store'});
    if(!r.ok) throw 0;
    const j = await r.json();
    return j;
  }catch{
    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols}`;
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    return j.quoteResponse?.result || [];
  }
}
function choosePrice(q){
  if(!q) return null;
  const ms = q.marketState;
  if((ms==='POST'||ms==='POSTPOST') && q.postMarketPrice) return q.postMarketPrice;
  if((ms==='PRE'||ms==='PREPRE') && q.preMarketPrice) return q.preMarketPrice;
  return q.regularMarketPrice ?? q.ask ?? q.bid ?? q.previousClose ?? null;
}

// ==== Refresh cycle
async function refresh(){
  const list = await fetchQuotes();
  const by = {}; list.forEach(q=> by[(q.symbol||'').toUpperCase()]=q);
  let total=0; const parts=[];
  for(const s of syms){
    const q = by[s] || {symbol:s};
    const px = choosePrice(q);
    if(px!=null) state.prices[s]=px;
    const sh = state.shares[s];
    const val = (px||0)*(sh||0);
    total += val;
    $('px-'+s).textContent = px? money(px):'$—';
    $('ms-'+s).textContent = q.marketState||'';
    $('val-'+s).textContent = `${sh} × ${px? money(px):'$—'} = ${money(val)}`;
    parts.push(`${s} ${px? px.toFixed(2):'—'}`);
  }
  $('total').textContent = money(total);
  if(state.lastTotal!=null){
    const d=total-state.lastTotal; const pct = state.lastTotal? d/state.lastTotal*100:0;
    const el=$('delta'); el.textContent = `${d>=0?'+':''}${d.toFixed(2)} (${pct>=0?'+':''}${pct.toFixed(2)}%) since last`;
    el.className = d>=0? 'text-green-600':'text-red-600';
    if(Math.abs(pct)>=3 && 'Notification' in window && Notification.permission==='granted'){
      new Notification(`Portfolio ${d>=0?"up":"down"} ${pct.toFixed(2)}%`, {body:`Total ${money(total)}`});
    }
  }
  state.lastTotal=total;
  state.history.push({t:Date.now(), total:Number(total.toFixed(2))});
  if(state.history.length>600) state.history.shift();
  save();
  pushFeed(`Auto • ${new Date().toLocaleTimeString()} → ${parts.join(' · ')} | Total ${money(total)}`);
  drawChart(); drawTicker(); renderInsights();
}

// ==== Feed
function pushFeed(text){
  state.feed.unshift({t:Date.now(), text});
  if(state.feed.length>200) state.feed.pop();
  renderFeed(); save();
}
function renderFeed(){
  const box=$('feed'); box.innerHTML='';
  if(state.feed.length===0){ box.innerHTML='<div class="text-sm text-slate-500">No updates yet.</div>'; return; }
  state.feed.forEach(u=>{
    const div=document.createElement('div');
    div.className='bg-white dark:bg-slate-800 rounded-xl p-3 shadow';
    div.textContent=`[${new Date(u.t).toLocaleTimeString()}] ${u.text}`;
    box.appendChild(div);
  });
}

// ==== Insights
function renderInsights(){
  const ul=$('insights'); ul.innerHTML='';
  const vals={}; let grand=0;
  for(const s of syms){ const v=(state.prices[s]||0)*(state.shares[s]||0); vals[s]=v; grand+=v; }
  const arr=Object.entries(vals).sort((a,b)=>b[1]-a[1]);
  if(!grand){ ul.innerHTML='<li>—</li>'; return; }
  const top=arr[0];
  ul.innerHTML += `<li>Top holding: <b>${top[0]}</b> ${money(top[1])} (${(top[1]/grand*100).toFixed(1)}%)</li>`;
  ul.innerHTML += `<li>Concentration: ${arr.map(([k,v])=>`${k} ${(v/grand*100).toFixed(1)}%`).join(' · ')}</li>`;
  const last5 = state.history.slice(-5).map(p=>money(p.total)).join(' → ');
  ul.innerHTML += `<li>Last 5 totals: ${last5}</li>`;
}

// ==== Levels & Watchlist
function renderLevels(){ const ul=$('levels'); ul.innerHTML=''; state.levels.forEach((t,i)=>{ const li=document.createElement('li'); li.className='flex justify-between'; li.innerHTML=`<span>${t}</span><button class='text-xs text-rose-500' data-i='${i}'>Remove</button>`; li.querySelector('button').onclick=(e)=>{state.levels.splice(i,1); renderLevels(); save();}; ul.appendChild(li); }); }
function renderWatch(){ const ul=$('watch'); ul.innerHTML=''; state.watch.forEach((t,i)=>{ const li=document.createElement('li'); li.className='flex justify-between'; li.innerHTML=`<span>${t}</span><button class='text-xs text-rose-500' data-i='${i}'>Remove</button>`; li.querySelector('button').onclick=()=>{state.watch.splice(i,1); renderWatch(); save();}; ul.appendChild(li); }); }

// ==== Chart & ticker
let eqChart; function drawChart(){ const labels=state.history.map(p=>new Date(p.t).toLocaleTimeString()); const data=state.history.map(p=>p.total); if(eqChart) eqChart.destroy(); eqChart=new Chart($('eq'),{type:'line',data:{labels, datasets:[{label:'Total ($)', data, tension:.25}]}, options:{responsive:true, maintainAspectRatio:false}}); }
function drawTicker(){ const el=$('ticker'); el.innerHTML = [...syms, ...state.watch].map(s=>`<span class='opacity-70'>${s}</span> <b>${state.prices[s]? state.prices[s].toFixed(2):'—'}</b>`).join("<span class='mx-4 opacity-40'>|</span>"); el.innerHTML += el.innerHTML; }

// ==== Controls
['VTAK','APVO','HYFT'].forEach(s=>{ $('sh-'+s).addEventListener('input',e=>{ state.shares[s]=Number(e.target.value)||0; save(); refresh(); }); });
$('addNote').onclick = ()=>{ const v=$('noteInput').value.trim(); if(!v) return; pushFeed(v); $('noteInput').value=''; };
$('addLevel').onclick = ()=>{ const v=$('levelInput').value.trim(); if(!v) return; state.levels.unshift(v); renderLevels(); save(); $('levelInput').value=''; };
$('addWatch').onclick = ()=>{ const v=$('watchInput').value.trim().toUpperCase(); if(!v) return; if(!state.watch.includes(v)) state.watch.push(v); renderWatch(); save(); $('watchInput').value=''; };
$('darkBtn').onclick = ()=> document.documentElement.classList.toggle('dark');
$('resetBtn').onclick = ()=>{ localStorage.removeItem(StoreKey); location.reload(); };
$('notifyBtn').onclick = ()=>{ if('Notification' in window && Notification.permission!=='granted') Notification.requestPermission(); };

$('exportBtn').onclick = ()=>{ const blob=new Blob([JSON.stringify({shares:state.shares, history:state.history, feed:state.feed, levels:state.levels, watch:state.watch}, null, 2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`nosson_stock_hq_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); };
$('importFile').onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const txt=await f.text(); const obj=JSON.parse(txt); Object.assign(state.shares, obj.shares||{}); state.history=obj.history||[]; state.feed=obj.feed||[]; state.levels=obj.levels||[]; state.watch=obj.watch||[]; save(); location.reload(); }catch{ alert('Invalid JSON'); } };

// Live button / countdown
$('liveBtn').onclick = ()=>{
  if(state.timer){ clearInterval(state.timer); state.timer=null; $('liveBtn').textContent='Start'; $('liveStatus').textContent='Idle'; $('countdown').textContent=''; return; }
  state.freq = Number($('freq').value)||300000; $('liveBtn').textContent='Stop'; $('liveStatus').textContent=`Running every ${Math.round(state.freq/60000)||1} min`;
  const tick=()=>{ refresh(); state.nextAt = Date.now()+state.freq; }; tick(); state.timer=setInterval(tick, state.freq);
};
setInterval(()=>{ if(!state.timer||!state.nextAt) return; const s=Math.max(0, Math.ceil((state.nextAt-Date.now())/1000)); $('countdown').textContent = `Next refresh in ${s}s`; }, 1000);

// Boot
load(); refresh();
</script>
</body>
</html>  </div>
</section>

<footer class="text-xs text-slate-500 text-center pb-8">Built for Nosson • Live quotes fetched from Yahoo Finance public endpoint. If blocked by CORS in your region, switch to Vercel function /api/quote (same JSON).</footer>

  </div>  <div id="ticker" class="fixed bottom-0 left-0 right-0 bg-slate-900 text-white text-sm py-2 px-4 flex gap-6 overflow-x-auto">Loading…</div><script>
const syms = ['VTAK','APVO','HYFT'];
const state = {
  shares: { VTAK: 3, APVO: 6, HYFT: 173 },
  prices: { VTAK: null, APVO: null, HYFT: null },
  lastTotal: null,
  history: [], // {t, total}
  timer: null,
  freq: 300000,
};

// Persist
function save(){ localStorage.setItem('nosson_live_v2', JSON.stringify({shares:state.shares, history:state.history})); }
function load(){
  const s = JSON.parse(localStorage.getItem('nosson_live_v2')||'null');
  if(s){ state.shares = Object.assign(state.shares, s.shares||{}); state.history = s.history||[]; }
  document.getElementById('sh-VTAK').value = state.shares.VTAK;
  document.getElementById('sh-APVO').value = state.shares.APVO;
  document.getElementById('sh-HYFT').value = state.shares.HYFT;
}

// UI helpers
function $(id){return document.getElementById(id)}
function fmt(n){return Number(n).toFixed(4)}
function money(n){return `$${Number(n).toFixed(2)}`}

// Fetch from Yahoo Finance public endpoint
async function fetchQuotes(){
  const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${syms.join(',')}`;
  const r = await fetch(url, {cache:'no-store'});
  const j = await r.json();
  const list = j.quoteResponse.result || [];
  const bySym = {};
  list.forEach(q=>{ bySym[q.symbol.toUpperCase()] = q; });
  return syms.map(s=> bySym[s]||{symbol:s});
}

function choosePrice(q){
  if(!q) return null;
  if((q.marketState==='POST' || q.marketState==='POSTPOST') && q.postMarketPrice) return q.postMarketPrice;
  if((q.marketState==='PRE' || q.marketState==='PREPRE') && q.preMarketPrice) return q.preMarketPrice;
  return q.regularMarketPrice ?? q.ask ?? q.bid ?? q.previousClose ?? null;
}

async function refresh(){
  try{
    const quotes = await fetchQuotes();
    let total = 0; const parts = [];
    for(const q of quotes){
      const s = (q.symbol||'').toUpperCase();
      const px = choosePrice(q);
      if(px!=null) state.prices[s]=px;
      const shares = state.shares[s];
      const val = (px||0) * (shares||0);
      total += val;
      $(`px-${s}`).textContent = px? money(px) : '$—';
      $(`ms-${s}`).textContent = q.marketState || '';
      $(`val-${s}`).textContent = `${shares} × ${px? money(px):'$—'} = ${money(val)}`;
      parts.push(`${s} ${px? px.toFixed(2):'—'}`);
    }
    $('#total').textContent = money(total);
    if(state.lastTotal!=null){
      const d = total - state.lastTotal;
      const pct = state.lastTotal? (d/state.lastTotal*100):0;
      $('#delta').textContent = `${d>=0?'+':''}${d.toFixed(2)} (${pct>=0?'+':''}${pct.toFixed(2)}%) since last`;
      $('#delta').className = d>=0? 'text-green-600' : 'text-red-600';
    }
    state.lastTotal = total;
    state.history.push({t:Date.now(), total:Number(total.toFixed(2))});
    if(state.history.length>400) state.history.shift();
    save();
    appendFeed(`Auto • ${new Date().toLocaleTimeString()} → ${parts.join(' · ')} | Total ${money(total)}`);
    drawChart();
    drawTicker();
  }catch(e){ appendFeed('Fetch error — falling back'); console.warn(e); }
}

function appendFeed(text){
  const wrap = document.createElement('div');
  wrap.className = 'bg-white dark:bg-slate-800 rounded-xl p-3 shadow';
  wrap.textContent = text;
  $('#feed').prepend(wrap);
  const max = 150; const feed = $('#feed');
  while(feed.children.length>max){ feed.lastChild.remove(); }
}

let eqChart;
function drawChart(){
  const labels = state.history.map(p=> new Date(p.t).toLocaleTimeString());
  const data = state.history.map(p=> p.total);
  if(eqChart) eqChart.destroy();
  eqChart = new Chart($('#eq'), {type:'line', data:{labels, datasets:[{label:'Total ($)', data, tension:.25}]}, options:{responsive:true, maintainAspectRatio:false}});
}

function drawTicker(){
  const el = $('#ticker');
  el.innerHTML = syms.map(s=>{
    const px = state.prices[s];
    return `<span class='font-semibold'>${s}</span> ${px? px.toFixed(2):'—'}`;
  }).join('<span class="opacity-40"> | </span>');
}

// Controls
['VTAK','APVO','HYFT'].forEach(s=>{
  $(`sh-${s}`).addEventListener('input', (e)=>{ state.shares[s] = Number(e.target.value)||0; save(); refresh(); });
});

$('#darkBtn').addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));
$('#resetBtn').addEventListener('click', ()=>{ localStorage.removeItem('nosson_live_v2'); location.reload(); });

$('#liveBtn').addEventListener('click', ()=>{
  if(state.timer){ clearInterval(state.timer); state.timer=null; $('#liveBtn').textContent='Start'; $('#liveStatus').textContent='Idle'; return; }
  state.freq = Number($('#freq').value)||300000;
  state.timer = setInterval(refresh, state.freq);
  $('#liveBtn').textContent='Stop';
  $('#liveStatus').textContent=`Running every ${Math.round(state.freq/60000)} min`;
  refresh();
});

// Init
load();
refresh();
</script></body>
</html>
